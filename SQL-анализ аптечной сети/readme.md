# SQL-анализ аптечной сети

## 1. SQL-скрипт для проведения многомерного ABC-анализа аптечной сети по количеству проданных позиций, по прибыли с позиции, по выручке.

### Логика работы:
#### Подготовка данных (CTE preparing):
Группировка продаж по продуктам (dr_ndrugs)

#### Расчет для каждого продукта:
- amount - общее количество проданных единиц
- profit - общая прибыль (выручка минус закупочная стоимость и скидки)
- revenue - общая выручка (количество × цена продажи минус скидки)

#### ABC-классификация:

Для каждой метрики продукты сортируются по убыванию значения

Присваиваются категории A/B/C по принципу Парето:
- A - топ-80% от общей суммы метрики
- B - следующие 15% (80-95%)
- C - оставшиеся 5%

#### Результат:
Для каждого продукта выводятся три ABC-категории (по количеству проданных позиций, по прибыли с позиции, по выручке).

## 2. Изменён SQL-скрипт из первой задачи, добавлен XYZ-анализ ассортимента аптечной сети к предыдущему запросу
### Логика работы:
#### Добавлен XYZ-анализ (стабильность спроса):
- preparing_xyz: Группировка продаж по продуктам и неделям (YYYY-WW)
- xyz: Расчет коэффициента вариации для каждого продукта:
- X (стабильный): `CV ≤ 0.1 (10%)`
- Y (переменный): `0.1 < CV ≤ 0.25 (25%)`
- Z (нестабильный): `CV > 0.25`
- Учитываются только продукты с данными за `4+` периодов `(HAVING COUNT(DISTINCT ym) >= 4)`

## 3. SQL-скрипт для анализа рыночной корзины (market basket analysis), который выявляет паттерны совместных покупок товаров в чеках. Анализ помогает понимать, какие товары покупатели склонны приобретать вместе.
### Логика работы:
#### Подготовка уникальных позиций в чеках:
- CTE soch: Уникальные комбинации аптеки, чека, даты и товара
- Устранение дубликатов товаров в одном чеке (если товар повторяется в чеке несколько раз, он учитывается один раз)
#### Самосоединение для выявления пар товаров:
- Соединение таблицы самой с собой по идентификаторам чека
- Условие s1.dr_ndrugs < s2.dr_ndrugs:
- Исключает дублирование пар (A+B и B+A считаются одной парой)
- Исключает пары товара с самим собой

#### Агрегация результатов:
- Подсчет количества совместных появлений для каждой уникальной пары товаров
- Сортировка по убыванию частоты совместных покупок

### Ключевые особенности
#### Анализ на уровне транзакций:
- Учитываются только товары, купленные в одном чеке
- Включает временной и пространственный контекст (аптека, дата)

#### Устранение избыточности:
- Уникальные пары через условие `<` вместо `<>`
- Группировка для устранения повторений товаров в чеке
#### Масштабируемость:
- Работает с большими объемами данных
- Легко адаптируется для расчета дополнительных метрик

## 4. SQL-скрипт для построения полной матрицы продаж, показывающей распределение продаж каждого товара по всем аптекам сети. Результат представляет собой кросс-таблицу формата "товар × аптека" с указанием количества проданных единиц.
### Логика работы:
#### Подготовка уникальных списков:
- products: Все уникальные товары, когда-либо продававшиеся
- pharmas: Все уникальные аптеки, в которых были продажи

#### Создание полной матрицы:
- `CROSS JOIN` между товарами и аптеками создает все возможные комбинации
- Это гарантирует, что в результате будут все товары для всех аптек

#### Присоединение фактических продаж:
- `LEFT JOIN` с таблицей продаж по товару и аптеке
- Если продаж не было, значение будет `NULL`

#### Агрегация и форматирование:
- Суммирование количества проданных единиц
- Округление до 2 знаков после запятой
- Группировка по аптеке и товару

### Ключевые особенности
- **Полнота данных:** Включает все комбинации товаров и аптек, даже с нулевыми продажами
- **Формат матрицы:** Идеально подходит для сводных таблиц и визуализаций
- **NULL-значения:** Явно показывает отсутствие продаж, а не скрывает строки
- **Гибкость:** Легко адаптируется для добавления других метрик (выручка, прибыль)
